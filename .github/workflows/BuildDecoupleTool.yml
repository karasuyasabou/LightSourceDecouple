name: Build Decouple Tool

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: macos
            arch: arm64
            extension: ''
            icon_file: icons/app.icns
            sep: ':'
            artifact_name: DecoupleTool-macOS-arm64.zip
          
          # 参考代码使用的 Runner
          - os: macos-15-intel
            platform: macos
            arch: x64
            extension: ''
            icon_file: icons/app.icns
            sep: ':'
            artifact_name: DecoupleTool-macOS-x64.zip

          - os: windows-latest
            platform: windows
            arch: x64
            extension: .exe
            icon_file: icons/app.ico
            sep: ';'
            artifact_name: DecoupleTool-Windows-x64.zip

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # 添加 PySide6 及其他核心依赖
        pip install PySide6 numpy tifffile imagecodecs Pillow pyinstaller pyinstaller-hooks-contrib

    - name: Prepare app icon (macOS)
      if: matrix.platform == 'macos'
      run: |
        if [ ! -f "icon.png" ]; then echo "::warning::icon.png not found"; exit 0; fi
        mkdir -p icons/icon.iconset
        sips -z 16 16     "icon.png" --out icons/icon.iconset/icon_16x16.png
        sips -z 32 32     "icon.png" --out icons/icon.iconset/icon_16x16@2x.png
        sips -z 32 32     "icon.png" --out icons/icon.iconset/icon_32x32.png
        sips -z 64 64     "icon.png" --out icons/icon.iconset/icon_32x32@2x.png
        sips -z 128 128   "icon.png" --out icons/icon.iconset/icon_128x128.png
        sips -z 256 256   "icon.png" --out icons/icon.iconset/icon_128x128@2x.png
        sips -z 256 256   "icon.png" --out icons/icon.iconset/icon_256x256.png
        sips -z 512 512   "icon.png" --out icons.iconset/icon_256x256@2x.png
        sips -z 512 512   "icon.png" --out icons.iconset/icon_512x512.png
        sips -z 1024 1024 "icon.png" --out icons.iconset/icon_512x512@2x.png
        iconutil -c icns -o icons/app.icns icons/icon.iconset
        echo "✅ Generated icons/app.icns"

    - name: Prepare app icon (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir icons
        python -c "from PIL import Image; img=Image.open('icon.png'); img.save('icons/app.ico', sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])"
        echo "✅ Generated icons/app.ico"

    - name: Build with PyInstaller
      run: |
        ICON_ARG=""
        if [ -f "${{ matrix.icon_file }}" ]; then ICON_ARG="--icon=${{ matrix.icon_file }}"; fi
        
        # PySide6 需要 --onedir 模式以获得最佳启动速度
        python -m PyInstaller --clean --noconfirm --windowed --noconsole --onedir \
          --name "DecoupleTool" \
          $ICON_ARG \
          --add-data "icon.png${{ matrix.sep }}." \
          --collect-all imagecodecs \
          --collect-all tifffile \
          decouple_tool.py

    - name: Package macOS App
      if: matrix.platform == 'macos'
      run: |
        cd dist
        chmod +x DecoupleTool.app/Contents/MacOS/DecoupleTool
        ditto -c -k --sequesterRsrc --keepParent DecoupleTool.app ${{ matrix.artifact_name }}

    - name: Package Windows App
      if: matrix.platform == 'windows'
      run: |
        cd dist
        powershell Compress-Archive -Path DecoupleTool -DestinationPath ${{ matrix.artifact_name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}
